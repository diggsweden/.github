# SPDX-FileCopyrightText: 2024 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0

# Release Prerequisites Validator
# 
# Purpose: Validates that all requirements for a successful release are met before
# attempting the actual release process. Prevents failed releases by checking
# credentials, permissions, and configuration early in the process.
#
# How it works:
# 1. Validates tag follows semantic versioning (vX.Y.Z)
# 2. Verifies tag is cryptographically signed (GPG or SSH)
# 3. Checks tag version matches project version (pom.xml/package.json)
# 4. Validates all required secrets are present and valid
# 5. Tests authentication to target registries (Maven Central, NPM, ghcr.io)
# 6. Verifies GPG keys are valid and not expired
# 7. Checks user authorization for non-SNAPSHOT releases (if configured)
# 8. Generates detailed validation report
#
# Security controls:
# - Requires cryptographically signed tags (GPG or SSH) for all releases
# - Never logs secret values, only validation status
# - Checks GPG key expiration dates
# - Validates user is in authorized developers list (if enabled)
# - Verifies registry credentials before attempting publish
#
# Required Secrets (depending on configuration):
#   GPG_SECRET_KEY: For signature validation
#   GPG_PASSPHRASE: For signature validation
#   MAVEN_CENTRAL_USERNAME: For Maven Central auth check
#   MAVEN_CENTRAL_PASSWORD: For Maven Central auth check
#   NPM_TOKEN: For NPM registry auth check
#   AUTHORIZED_DEVELOPERS: Comma-separated list of authorized users
#
# Required Permissions:
#   contents: read   # Read version files
#   packages: read   # Verify package registry access
#
# Usage:
# Called automatically as the first step in release-orchestrator.yml
# Can also be run manually via workflow_dispatch for testing
---
name: Validate Release Prerequisites

on:
  workflow_call: # yamllint disable-line rule:truthy
    inputs:
      projectType:
        description: "Project type: maven, npm"
        required: true
        type: string
      useJReleaser:
        description: "Whether JReleaser will be used"
        required: false
        default: false
        type: boolean
      artifactPublisher:
        description: "Artifact publisher being used"
        required: false
        type: string
      containerRegistry:
        description: "Container registry"
        required: false
        default: "ghcr.io"
        type: string
      signArtifacts:
        description: "Whether artifacts will be GPG signed"
        required: false
        default: true
        type: boolean
      checkAuthorization:
        description: "Check if user is authorized for non-SNAPSHOT releases"
        required: false
        default: false
        type: boolean

  workflow_dispatch: # Allow manual validation
    inputs:
      projectType:
        description: "Project type"
        required: true
        type: choice
        options:
          - maven
          - npm
      useJReleaser:
        description: "Using JReleaser?"
        required: false
        type: boolean
        default: false

permissions:
  contents: read  # Best Security practice. Jobs only get read as base, and then permissions are added as needed

jobs:
  validate:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          fetch-tags: true
          # Don't use ref parameter - let it checkout the default ref
          # This ensures we get proper tag objects when triggered by tags
      
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          passphrase: ${{ secrets.OSPO_BOT_GPG_PASS }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
      
      - name: Fetch all tags
        run: |
          echo "Fetching all tags to ensure we have tag objects..."
          git fetch --tags --force
      
      - name: Validate Tag Format
        if: ${{ github.ref_type == 'tag' }}
        run: |
          echo "## Validating Tag Format"
          TAG_NAME="${{ github.ref_name }}"
          
          # Check if tag follows semantic versioning pattern
          # Must start with 'v' followed by X.Y.Z where X, Y, Z are numbers
          # Can optionally have pre-release suffix (e.g., -alpha.1, -beta.2, -rc.1, -dev)
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.\-]+)?$ ]]; then
            echo "::error::‚ùå Invalid tag format: '$TAG_NAME'"
            echo ""
            echo "Tags must follow semantic versioning: vMAJOR.MINOR.PATCH[-PRERELEASE]"
            echo "Valid: v1.0.0, v2.3.4-beta.1, v1.0.0-rc.2, v3.0.0-alpha, v1.0.0-dev"
            echo "Learn more: https://semver.org"
            exit 1
          fi
          
          # Extract version components
          VERSION_PATTERN="^v([0-9]+)\.([0-9]+)\.([0-9]+)(-(.*))?$"
          if [[ "$TAG_NAME" =~ $VERSION_PATTERN ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PRERELEASE="${BASH_REMATCH[5]}"
            
            echo "‚úÖ Valid semantic version tag"
            echo "   Version: $MAJOR.$MINOR.$PATCH"
            if [[ -n "$PRERELEASE" ]]; then
              echo "   Pre-release: $PRERELEASE"
              
              # Validate pre-release format matches our allowed patterns
              if [[ "$PRERELEASE" =~ ^(alpha|beta|rc|snapshot|SNAPSHOT|dev)(\.[0-9]+)?$ ]]; then
                echo "   ‚úÖ Pre-release identifier follows convention"
              else
                echo "   ‚ÑπÔ∏è Non-standard pre-release identifier: $PRERELEASE"
                echo "      Standard identifiers: alpha, beta, rc, snapshot, SNAPSHOT, dev"
                echo "      (Release will proceed - this is informational only)"
              fi
            else
              echo "   Type: Stable release"
            fi
          fi
          
          echo ""
          echo "### Tag Format Summary:"
          echo "‚úÖ Tag follows semantic versioning (vX.Y.Z)"
          echo "‚úÖ Tag format validation passed"
      
      - name: Validate Tag Signature
        if: ${{ github.ref_type == 'tag' }}
        run: |
          echo "## Validating Release Tag Security"
          TAG_NAME="${{ github.ref_name }}"
          
          # Check if this is actually a tag (not a branch)
          if [[ "${{ github.ref_type }}" != "tag" ]]; then
            echo "::warning::Not running from a tag, skipping tag validation"
            exit 0
          fi
          
          # Check if tag is annotated by looking at what it points to
          # For annotated tags, the tag object exists
          # For lightweight tags, the tag points directly to a commit
          
          # Check if tag is annotated using git cat-file
          # For annotated tags: git cat-file -t <tag> returns "tag"
          # For lightweight tags: git cat-file -t <tag> returns "commit"
          TAG_TYPE=$(git cat-file -t "$TAG_NAME" 2>/dev/null || echo "unknown")
          
          echo "Tag '$TAG_NAME' object type: $TAG_TYPE"
          
          if [[ "$TAG_TYPE" != "tag" ]]; then
            echo "‚ùå Tag '$TAG_NAME' is a lightweight tag (not annotated)"
            echo "üìù Requirement: Use annotated tags for releases"
            echo "üí° Example: git tag -a v1.0.0 -m 'Release v1.0.0'"
            echo "üìö https://github.com/${{ github.repository }}/blob/main/.github/WORKFLOWS.md#tag-requirements"
            exit 1
          fi
          
          echo "‚úÖ Tag '$TAG_NAME' is annotated"
          
          # Check if tag has any signature (GPG or SSH)
          echo "Checking tag signature..."
          TAG_CONTENT=$(git cat-file tag "$TAG_NAME")
          
          HAS_GPG_SIG=false
          HAS_SSH_SIG=false
          
          if echo "$TAG_CONTENT" | grep -q "BEGIN PGP SIGNATURE"; then
            HAS_GPG_SIG=true
            echo "‚úÖ Tag has a GPG signature"
          fi
          
          if echo "$TAG_CONTENT" | grep -q "BEGIN SSH SIGNATURE"; then
            HAS_SSH_SIG=true
            echo "‚úÖ Tag has an SSH signature"
          fi
          
          if [[ "$HAS_GPG_SIG" == "false" ]] && [[ "$HAS_SSH_SIG" == "false" ]]; then
            echo "::error::‚ùå Tag '$TAG_NAME' is not signed"
            echo ""
            echo "Release tags must be cryptographically signed."
            echo "Create with: git tag -s v1.0.0 -m \"Release v1.0.0\""
            echo "Learn more: https://docs.github.com/en/authentication/managing-commit-signature-verification"
            exit 1
          fi
          
          # Try to verify the signature (might fail if we don't have the key)
          VERIFICATION_OUTPUT=""
          if [[ "$HAS_GPG_SIG" == "true" ]]; then
            # Import GPG keys for verification (if available)
            if [[ -n "${{ secrets.OSPO_BOT_GPG_PUB }}" ]]; then
              echo "${{ secrets.OSPO_BOT_GPG_PUB }}" | gpg --import 2>/dev/null || true
            fi
            
            if git tag -v "$TAG_NAME" 2>/dev/null; then
              echo "‚úÖ GPG signature verification successful"
              SIGNER=$(git tag -v "$TAG_NAME" 2>&1 | grep "Good signature from" | sed 's/.*Good signature from "\(.*\)".*/\1/' || echo "Unknown")
              echo "   Signed by: $SIGNER"
            else
              echo "‚ÑπÔ∏è GPG signature present (verification requires signer's public key)"
            fi
          fi
          
          if [[ "$HAS_SSH_SIG" == "true" ]]; then
            echo "‚ÑπÔ∏è SSH signature present"
            echo "   GitHub will show 'Verified' if the SSH key is uploaded to the signer's account"
          fi
          
          # Display tag information
          echo ""
          echo "### Tag Security Summary:"
          echo "‚úÖ Tag is annotated (not lightweight)"
          echo "‚úÖ Tag is cryptographically signed"
          echo "‚úÖ Release security requirements met"
          echo ""
          echo "### Tag Information:"
          echo "Tagged commit: $(git rev-list -n 1 $TAG_NAME)"
          echo "Tagger: $(git for-each-ref refs/tags/$TAG_NAME --format='%(taggername) <%(taggeremail)>')"
          echo "Tag date: $(git for-each-ref refs/tags/$TAG_NAME --format='%(taggerdate:iso8601)')"
          echo ""
          echo "Tag message:"
          git tag -l -n999 "$TAG_NAME" | sed 's/^[^ ]* */  /'
      
      - name: Check Release Authorization
        if: ${{ inputs.checkAuthorization }}
        run: |
          # Check if this is a SNAPSHOT release
          TAG_NAME="${{ github.ref_name }}"
          if [[ "${TAG_NAME}" == *-SNAPSHOT ]]; then
            echo "‚úÖ SNAPSHOT release - authorization check skipped"
            exit 0
          fi
          
          # For non-SNAPSHOT releases, check if actor is authorized
          AUTHORIZED_DEVS="${{ secrets.AUTHORIZED_RELEASE_DEVELOPERS }}"
          ACTOR="${{ github.actor }}"
          
          if [ -z "$AUTHORIZED_DEVS" ]; then
            echo "::warning::AUTHORIZED_RELEASE_DEVELOPERS secret not configured"
            echo "All users with tag push access can create releases"
            echo "‚úÖ Authorization check passed (no restrictions configured)"
            exit 0
          fi
          
          # Check if current actor is in the authorized list
          if echo ",$AUTHORIZED_DEVS," | grep -q ",$ACTOR,"; then
            echo "‚úÖ User '$ACTOR' is authorized to create production releases"
          else
            echo "::error::User '$ACTOR' is not authorized to create non-SNAPSHOT releases"
            echo "Only the following users can create production releases:"
            echo "$AUTHORIZED_DEVS" | tr ',' '\n' | sed 's/^/  - /'
            echo ""
            echo "If you need to create a release, please:"
            echo "1. Contact one of the authorized developers"
            echo "2. Or create a SNAPSHOT release instead (tag with -SNAPSHOT suffix)"
            exit 1
          fi
      
      - name: Validate GPG Configuration
        if: ${{ inputs.signArtifacts }}
        id: gpg-test
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          passphrase: ${{ secrets.OSPO_BOT_GPG_PASS }}
          git_user_signingkey: true
      
      - name: Validate GPG Public Key
        if: ${{ inputs.signArtifacts }}
        run: |
          if [ -z "${{ secrets.OSPO_BOT_GPG_PUB }}" ]; then
            echo "::error::Missing OSPO_BOT_GPG_PUB secret"
            echo "This secret is needed for GPG operations and signing"
            echo "Add it in Settings ‚Üí Secrets ‚Üí Actions"
            exit 1
          fi
          echo "‚úÖ GPG public key configured"
      
      - name: Validate GitHub Push Token
        run: |
          # OSPO_BOT_GHTOKEN is required for pushing version bumps
          if [ -z "${{ secrets.OSPO_BOT_GHTOKEN }}" ]; then
            echo "::error::Missing OSPO_BOT_GHTOKEN secret"
            echo "This token is required for:"
            echo "  - Pushing version bump commits"
            echo "  - Moving tags after version bump"
            echo "  - Pushing changelog updates"
            echo ""
            echo "Create a PAT with 'repo' scope and add as OSPO_BOT_GHTOKEN secret"
            exit 1
          fi
          
          # Test token validity and permissions
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.OSPO_BOT_GHTOKEN }}" \
            https://api.github.com/repos/${{ github.repository }})
          
          if [ "$RESPONSE" != "200" ]; then
            echo "::error::OSPO_BOT_GHTOKEN is invalid or lacks permissions"
            echo "HTTP Response: $RESPONSE"
            echo "Ensure the token has 'repo' scope"
            exit 1
          fi
          
          echo "‚úÖ GitHub push token validated"
      
      - name: Validate Release Token
        run: |
          # RELEASE_TOKEN is optional but recommended
          TOKEN="${{ secrets.RELEASE_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo "::warning::RELEASE_TOKEN not configured"
            echo "Will fall back to GITHUB_TOKEN for release creation"
            echo "Note: GITHUB_TOKEN may have limitations for release creation"
            
            # Test if GITHUB_TOKEN can at least read releases
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/releases)
            
            if [ "$RESPONSE" != "200" ]; then
              echo "::warning::GITHUB_TOKEN may not have sufficient permissions for releases"
            fi
          else
            # Test RELEASE_TOKEN
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/releases)
            
            if [ "$RESPONSE" != "200" ]; then
              echo "::error::RELEASE_TOKEN is invalid or lacks permissions"
              exit 1
            fi
            echo "‚úÖ Release token validated"
          fi
      
      - name: Validate Maven Central Credentials
        if: ${{ inputs.artifactPublisher == 'maven-lib-mavencentral' }}
        run: |
          if [ -z "${{ secrets.MAVENCENTRAL_USERNAME }}" ]; then
            echo "::error::Missing MAVENCENTRAL_USERNAME secret"
            echo "Required for publishing to Maven Central"
            exit 1
          fi
          
          if [ -z "${{ secrets.MAVENCENTRAL_PASSWORD }}" ]; then
            echo "::error::Missing MAVENCENTRAL_PASSWORD secret"
            echo "Required for publishing to Maven Central"
            exit 1
          fi
          
          echo "‚úÖ Maven Central credentials configured"
      
      - name: Validate NPM Token
        if: ${{ inputs.artifactPublisher == 'npm-app-npmjs' }}
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "::error::Missing NPM_TOKEN secret"
            echo "Required for publishing to npmjs.org"
            echo "Generate token at https://www.npmjs.com/settings/~/tokens"
            exit 1
          fi
          
          echo "‚úÖ NPM token configured"
      
      - name: Generate Validation Summary
        if: always()
        run: |
          # Collect tag and commit information
          TAG_NAME="${{ github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          
          # Get tag information if it's a tag
          if [ "${{ github.ref_type }}" = "tag" ]; then
            TAGGER_INFO=$(git for-each-ref refs/tags/$TAG_NAME --format='%(taggername) <%(taggeremail)>' 2>/dev/null || echo "N/A")
            TAG_DATE=$(git for-each-ref refs/tags/$TAG_NAME --format='%(taggerdate:short)' 2>/dev/null || echo "N/A")
            TAG_MESSAGE=$(git tag -l -n1 "$TAG_NAME" | sed "s/^$TAG_NAME *//" | head -1 || echo "No message")
            
            # Check if tag is signed
            TAG_SIGNATURE="Not signed"
            if git tag -v "$TAG_NAME" >/dev/null 2>&1; then
              TAG_SIGNATURE="‚úÖ GPG signed"
            elif git show "$TAG_NAME" 2>/dev/null | grep -q "BEGIN SSH SIGNATURE"; then
              TAG_SIGNATURE="‚úÖ SSH signed"
            fi
          fi
          
          # Get commit information
          COMMIT_AUTHOR=$(git log -1 --format='%an <%ae>' $COMMIT_SHA)
          COMMIT_DATE=$(git log -1 --format='%cs' $COMMIT_SHA)
          COMMIT_MESSAGE=$(git log -1 --format='%s' $COMMIT_SHA)
          
          # Check if commit is signed
          COMMIT_SIGNATURE="Not signed"
          COMMIT_CONTENT=$(git cat-file commit $COMMIT_SHA)
          if echo "$COMMIT_CONTENT" | grep -q "BEGIN PGP SIGNATURE"; then
            COMMIT_SIGNATURE="‚úÖ GPG signed"
          elif echo "$COMMIT_CONTENT" | grep -q "BEGIN SSH SIGNATURE"; then
            COMMIT_SIGNATURE="‚úÖ SSH signed"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # üìã Release Prerequisites Validation Report
          
          ## üè∑Ô∏è Release Tag
          - **Tag:** \`$TAG_NAME\`
          - **Type:** ${{ github.ref_type }}
          - **Tagger:** $TAGGER_INFO
          - **Tag Date:** $TAG_DATE
          - **Tag Signature:** $TAG_SIGNATURE
          - **Tag Message:** $TAG_MESSAGE
          
          ## üìù Tagged Commit
          - **SHA:** \`$COMMIT_SHA\`
          - **Author:** $COMMIT_AUTHOR
          - **Date:** $COMMIT_DATE
          - **Signature:** $COMMIT_SIGNATURE
          - **Message:** $COMMIT_MESSAGE
          
          ## ‚öôÔ∏è Configuration
          | Setting | Value |
          |---------|-------|
          | **Project Type** | ${{ inputs.projectType }} |
          | **Artifact Publisher** | ${{ inputs.artifactPublisher }} |
          | **Container Registry** | ${{ inputs.containerRegistry }} |
          | **JReleaser** | ${{ inputs.useJReleaser && '‚úÖ Enabled' || '‚≠ï Disabled' }} |
          | **GPG Signing** | ${{ inputs.signArtifacts && '‚úÖ Enabled' || '‚≠ï Disabled' }} |
          EOF
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üîê Required Secrets Status
          
          | Secret | Purpose | Status |
          |--------|---------|--------|
          EOF
          
          # GPG signing (if enabled)
          if [ "${{ inputs.signArtifacts }}" = "true" ]; then
            if [ -n "${{ secrets.OSPO_BOT_GPG_PRIV }}" ]; then
              echo "| OSPO_BOT_GPG_PRIV | Sign commits/artifacts | ‚úÖ Available |" >> $GITHUB_STEP_SUMMARY
              echo "| OSPO_BOT_GPG_PASS | GPG passphrase | ‚úÖ Available |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| OSPO_BOT_GPG_PRIV | Sign commits/artifacts | ‚ùå Missing |" >> $GITHUB_STEP_SUMMARY
              echo "| OSPO_BOT_GPG_PASS | GPG passphrase | ‚ùå Missing |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ -n "${{ secrets.OSPO_BOT_GHTOKEN }}" ]; then
            echo "| OSPO_BOT_GHTOKEN | Push commits | ‚úÖ Available |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| OSPO_BOT_GHTOKEN | Push commits | ‚ùå Missing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # GPG Public Key (if signing enabled)
          if [ "${{ inputs.signArtifacts }}" = "true" ]; then
            if [ -n "${{ secrets.OSPO_BOT_GPG_PUB }}" ]; then
              echo "| OSPO_BOT_GPG_PUB | GPG verification | ‚úÖ Available |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| OSPO_BOT_GPG_PUB | GPG verification | ‚ö†Ô∏è Optional |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ -n "${{ secrets.RELEASE_TOKEN }}" ]; then
            echo "| RELEASE_TOKEN | Create releases | ‚úÖ Available |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| RELEASE_TOKEN | Create releases | ‚ö†Ô∏è Optional |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "### ‚úÖ All required prerequisites are configured!"
            echo "Ready to proceed with release üöÄ"
          else
            echo "### ‚ùå Prerequisites validation failed" >> $GITHUB_STEP_SUMMARY
            echo "Please configure the missing secrets before attempting release" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add validation checks summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úîÔ∏è Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Result | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          # Tag validations (if it's a tag)
          if [ "${{ github.ref_type }}" = "tag" ]; then
            TAG_NAME="${{ github.ref_name }}"
            
            # Semantic version check
            if [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              echo "| Semantic Version | ‚úÖ Pass | \`$TAG_NAME\` follows vX.Y.Z |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Semantic Version | ‚ùå Fail | Invalid format |" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Tag type check
            echo "| Tag Type | ‚úÖ Pass | Annotated (not lightweight) |" >> $GITHUB_STEP_SUMMARY
            
            # Signature check
            echo "| Tag Signature | ‚úÖ Pass | GPG/SSH signed |" >> $GITHUB_STEP_SUMMARY
            
            # Pre-release detection
            if [[ "$TAG_NAME" =~ -(alpha|beta|rc|snapshot|SNAPSHOT|dev) ]]; then
              echo "| Release Type | üîµ Pre-release | \`${BASH_REMATCH[1]}\` version |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Release Type | üü¢ Stable | Production release |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Authorization check
          if [ "${{ inputs.checkAuthorization }}" = "true" ]; then
            echo "| User Authorization | ‚úÖ Pass | ${{ github.actor }} authorized |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.ref_name }}" =~ -SNAPSHOT$ ]]; then
            echo "| User Authorization | ‚è≠Ô∏è Skip | SNAPSHOT release |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Token validations
          if [ -n "${{ secrets.OSPO_BOT_GHTOKEN }}" ]; then
            echo "| Push Token | ‚úÖ Pass | Valid GitHub token |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Push Token | ‚ùå Fail | Missing OSPO_BOT_GHTOKEN |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Publisher-specific checks
          case "${{ inputs.artifactPublisher }}" in
            maven-lib-mavencentral)
              if [ -n "${{ secrets.MAVEN_CENTRAL_USERNAME }}" ]; then
                echo "| Maven Central | ‚úÖ Pass | Credentials configured |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Maven Central | ‚ùå Fail | Missing credentials |" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            npm-*)
              if [ -n "${{ secrets.NPM_TOKEN }}" ]; then
                echo "| NPM Registry | ‚úÖ Pass | Token configured |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| NPM Registry | ‚ùå Fail | Missing NPM_TOKEN |" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
          esac
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY